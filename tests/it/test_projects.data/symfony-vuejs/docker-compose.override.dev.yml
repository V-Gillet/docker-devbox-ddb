version: '3.7'
services:
  php:
    environment:
      - 'XDEBUG_CONFIG=remote_enable=on remote_autostart=off idekey=biometrie remote_host=${HOST_IP}'
      - 'PHP_IDE_CONFIG=serverName=biometrie'
  db:
    ports:
      - '${DOCKER_DEVBOX_PORT_PREFIX}32:5432'
  keycloak-db:
    ports:
      - '${DOCKER_DEVBOX_PORT_PREFIX}42:5432'
  db-test:
    build:
      context: .docker/db
      cache_from:
        - '${DOCKER_DEVBOX_REGISTRY}${DOCKER_DEVBOX_REGISTRY_REPOSITORY}/db'
    image: '${DOCKER_DEVBOX_REGISTRY}${DOCKER_DEVBOX_REGISTRY_REPOSITORY}/db'
    init: true
    restart: '${DOCKER_DEVBOX_RESTART_POLICY}'
    ports:
      - '${DOCKER_DEVBOX_PORT_PREFIX}33:5432'
    environment:
      - POSTGRES_USER=biometrie
      - POSTGRES_PASSWORD=biometrie
    volumes:
      - '${COMPOSE_PROJECT_DIR}:/workdir'
      - 'db-test-data:/var/lib/postgresql/data'
    user: '${USER_ID}:${GROUP_ID}'
  ldap:
    build:
      context: .docker/ldap
      cache_from:
        - '${DOCKER_DEVBOX_REGISTRY}${DOCKER_DEVBOX_REGISTRY_REPOSITORY}/ldap'
    image: '${DOCKER_DEVBOX_REGISTRY}${DOCKER_DEVBOX_REGISTRY_REPOSITORY}/ldap'
    init: true
    restart: '${DOCKER_DEVBOX_RESTART_POLICY}'
    environment:
      - LDAP_ORGANISATION=${DOCKER_DEVBOX_DOMAIN_PREFIX}
      - LDAP_DOMAIN=${DOCKER_DEVBOX_DOMAIN_PREFIX}.${DOCKER_DEVBOX_DOMAIN}
      - LDAP_ADMIN_PASSWORD=${DOCKER_DEVBOX_DOMAIN_PREFIX}
    command: --copy-service --loglevel debug
    ports:
      - ${DOCKER_DEVBOX_PORT_PREFIX}89:389
      - ${DOCKER_DEVBOX_PORT_PREFIX}36:636
volumes:
  db-test-data: null
